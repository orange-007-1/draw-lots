<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽签系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c0c2e 0%, #1a1a3e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .tech-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .grid-line {
            position: absolute;
            background: rgba(0, 247, 255, 0.05);
        }
        .grid-line.horizontal { width: 100%; height: 1px; }
        .grid-line.vertical { width: 1px; height: 100%; }

        .glowing-dots {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background-color: #00f7ff;
            box-shadow: 0 0 10px 2px #00f7ff;
            animation: pulse 3s infinite alternate;
        }
        @keyframes pulse {
            0% { opacity: 0.3; }
            100% { opacity: 0.8; }
        }

        header {
            text-align: center;
            padding: 25px 20px;
            background: rgba(0, 20, 40, 0.7);
            border-bottom: 1px solid rgba(0, 247, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 50, 0.5);
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00f7ff, transparent);
            animation: headerGlow 3s infinite;
        }
        @keyframes headerGlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        h1 {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(90deg, #00f7ff, #66ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(0, 247, 255, 0.5);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #a0d2ff;
            font-size: 16px;
            letter-spacing: 1px;
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }


        .control-panel {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 20, 60, 0.5);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .control-group {
            background: rgba(0, 40, 80, 0.5);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        .control-group.list1 { border-left-color: #00f7ff; }
        .control-group.list2 { border-left-color: #66ccff; }

        .control-title {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .list1 .control-title { color: #00f7ff; }
        .list2 .control-title { color: #66ccff; }

        .control-item { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #b0d0ff;
            font-weight: 500;
        }
        select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 60, 120, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        select:focus {
            border-color: #00f7ff;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.5);
        }
        .blue-select { color: #66ccff; font-weight: 500; }


        .tail-filter-row {
            background: rgba(0, 50, 100, 0.7);
            border-radius: 12px;
            padding: 20px 25px;
            margin: 0 0 25px 0;
            border: 1px solid rgba(0, 200, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 150, 255, 0.2);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
        }
        .tail-filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
            color: #b0f0ff;
            text-shadow: 0 0 8px #00f7ff;
        }
        .tail-filter-label i { font-size: 24px; color: #00f7ff; }
        .tail-number-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex: 1;
        }
        .tail-number {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 100, 200, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.2s;
            border: 2px solid transparent;
            color: #cceeff;
        }
        .tail-number:hover {
            background: rgba(0, 150, 255, 0.6);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 200, 255, 0.4);
        }
        .tail-number.selected {
            background: #00f7ff;
            color: #003366;
            border-color: #00f7ff;
            box-shadow: 0 0 15px #00f7ff;
            font-weight: 700;
        }
        .tail-filter-info {
            color: #88ddff;
            padding: 6px 15px;
            background: rgba(0, 80, 160, 0.5);
            border-radius: 20px;
            font-size: 15px;
            border-left: 3px solid #00f7ff;
        }

        .button-panel {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 30px 0;
        }
        .btn {
            padding: 15px 35px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .btn i { font-size: 20px; }
        .btn-start { background: linear-gradient(135deg, #0066ff, #00ccff); color: white; }
        .btn-start:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 102, 255, 0.4); }
        .btn-stop { background: linear-gradient(135deg, #ff3333, #ff6666); color: white; }
        .btn-stop:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(255, 51, 51, 0.4); }
        .btn-reset { background: linear-gradient(135deg, #9933ff, #cc66ff); color: white; }
        .btn-reset:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(153, 51, 255, 0.4); }

        .rolling-display {
            background: rgba(0, 20, 40, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: 0 5px 20px rgba(0, 20, 60, 0.5);
            min-height: 220px;
            display: flex;
            flex-direction: column;
        }
        .rolling-title {
            font-size: 22px;
            color: #a0d2ff;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .rolling-area {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
            justify-items: center;
        }
        .name-slot {
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 40, 80, 0.6);
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(0, 150, 255, 0.2);
        }
        .name-slot.rolling {
            background: rgba(0, 60, 120, 0.7);
            border-color: rgba(0, 247, 255, 0.5);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.3);
        }
        .name-slot.list1 { color: #00f7ff; }
        .name-slot.list2 { color: #66ccff; }
        .name-slot.special {
            color: #ff9900;
            border-color: rgba(255, 153, 0, 0.5);
            background: rgba(255, 153, 0, 0.1);
        }

        /* ----- 结果显示区域 ----- */
        .result-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        .result-panel {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 20, 60, 0.5);
        }
        .result-title {
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }
        .result-title.list1 { color: #00f7ff; border-bottom-color: #00f7ff; }
        .result-title.list2 { color: #66ccff; border-bottom-color: #66ccff; }
        .result-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .result-list::-webkit-scrollbar { width: 8px; }
        .result-list::-webkit-scrollbar-track { background: rgba(0, 40, 80, 0.5); border-radius: 4px; }
        .result-list::-webkit-scrollbar-thumb { background: #00aaff; border-radius: 4px; }
        .result-item {
            padding: 12px 10px;
            text-align: center;
            background: rgba(0, 60, 120, 0.4);
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .result-item:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 100, 200, 0.2); }
        .result-item.list1 { color: #00f7ff; }
        .result-item.list2 { color: #66ccff; }
        .result-item.special {
            color: #ff9900;
            border-color: rgba(255, 153, 0, 0.5);
            background: rgba(255, 153, 0, 0.1);
        }
        .result-item.high-prob {
            border-color: rgba(0, 247, 255, 0.5);
            background: rgba(0, 247, 255, 0.1);
        }

        .status-indicator {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(0, 40, 80, 0.5);
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-dot.active { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .status-dot.inactive { background-color: #666; }

        
        @media (max-width: 1100px) {
            .result-display { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .control-panel { grid-template-columns: 1fr; }
            .button-panel { flex-direction: column; align-items: center; }
            .btn { width: 100%; max-width: 300px; justify-content: center; }
            .result-display { grid-template-columns: 1fr; }
            h1 { font-size: 32px; }
        }
    </style>
</head>
<body>
    <div class="tech-bg" id="techBg"></div>

    <header>
        <h1><i class="fas fa-random"></i> 抽签系统</h1>
        <p class="subtitle">随机抽取 | 双名单独立抽取</p>
    </header>

    <div class="container">
        <div class="control-panel">
            <div class="control-group list1">
                <div class="control-title"><i class="fas fa-list-ol"></i> 名单一设置</div>
                <div class="control-item">
                    <label>抽取人数：</label>
                    <select id="list1Count" class="blue-select">
                        <option value="0">请选择人数</option>
                    </select>
                </div>
                <div class="control-item">
                </div>
            </div>
            <div class="control-group list2">
                <div class="control-title"><i class="fas fa-list-alt"></i> 名单二设置</div>
                <div class="control-item">
                    <label>抽取人数：</label>
                    <select id="list2Count" class="blue-select">
                        <option value="0">请选择人数</option>
                    </select>
                </div>
                <div class="control-item">
                </div>
            </div>
        </div>


        <div class="tail-filter-row">
            <div class="tail-filter-label">
                <i class="fas fa-filter"></i> 尾号筛选
            </div>
            <div class="tail-number-selector" id="tailNumberSelector">
            </div>
            </div>
        </div>

        <div class="button-panel">
            <button class="btn btn-start" id="startBtn"><i class="fas fa-play"></i> 开始抽签</button>
            <button class="btn btn-stop" id="stopBtn" disabled><i class="fas fa-stop"></i> 停止</button>
            <button class="btn btn-reset" id="resetBtn"><i class="fas fa-redo"></i> 重置</button>
        </div>

        <div class="rolling-display">
            <div class="rolling-title"><i class="fas fa-spinner fa-spin"></i> 名字滚动区域</div>
            <div class="rolling-area" id="rollingArea"><div class="name-slot">准备开始抽签...</div></div>
        </div>

        <div class="result-display">
            <div class="result-panel">
                <h2 class="result-title list1"><i class="fas fa-users"></i> 名单一抽中结果</h2>
                <div class="result-list" id="list1Result"><div class="result-item list1">等待抽签结果...</div></div>
            </div>
            <div class="result-panel">
                <h2 class="result-title list2"><i class="fas fa-users"></i> 名单二抽中结果</h2>
                <div class="result-list" id="list2Result"><div class="result-item list2">等待抽签结果...</div></div>
            </div>
        </div>
    </div>

    <script>
        const data = {
            list1: [
                "085777", "085406", "085760", "085381", "085535", "047749", "106620", "085212",
                "105972", "046819", "085295", "106110", "106228", "047307", "048840", "085549", 
                "085511", "047980", "046829", "047735", "047738", "047915", "047148", "106016", 
                "047809", "085827", "047952", "106302", "085410", "085598", "106332", "049543", 
                "047304", "047941", "049465", "049424", "048055", "047389", "106172", "106502", 
                "085368", "047921", "047850", "118636", "047830", "047797", "047847", "048053", 
                "085378", "047999", "085377", "048038", "106145", "048914", "048735", "085952", 
                "106514", "047386", "049567", "085872", "085562", "085906", "106536", "047917", 
                "106382", "085978", "085389", "047509", "085405", "047994", "046821", "047949", 
                "106372", "046963", "085909", "085615", "105978", "085763", "085384", "085345", 
                "085970", "106625", "048088", "106292", "047303", "047017", "047109", "047664", 
                "085408", "106443", "085503", "085285", "047844", "048067", "047828", "105977", 
                "085395", "047815", "085883", "048089", "047392", "047387", "085376", "047862", 
                "106518", "049748", "085884", "085495", "047729", "046934", "106460", "105967", 
                "085881", "085491", "048058", "049779", "106062", "046982", "047394", "047824", 
                "106169", "106320", "047919", "106520", "085371", "047860", "085524", "085407", 
                "106168", "047525", "047734", "047995", "048042", "085387", "106323", "085965", 
                "106166", "085837", "046878", "085268", "047916", "106513", "047284", "085545", 
                "047162", "106196", "047406", "085882", "106521", "085282", "085759", "106107", 
                "085538", "085976", "085966", "047446", "049471", "047481", "106526", "047841", 
                "085640", "047842", "048045", "085840", "085539", "048077", "085528", "105970", 
                "085374", "047978", "048022", "047736", "048035", "085409", "085596", "085411", 
                "047163", "048046", "085490", "047569", "047032", "106584", "047398", "047834", 
                "085856", "048041", "047968", "047715", "085977", "106031", "106603", "047399", 
                "048066", "085576", "047956", "047894", "048028", "106226", "106173", "047936", 
                "047313", "085382", "047803", "048027", "047953", "047801", "085397", "047863", 
                "048084", "047832", "047730", "085564", "048076", "047383", "049757", "106099", 
                "106546", "105975", "047913", "049719", "047909", "085205", "047918", "048054", 
                "048083", "047783", "047737", "047957", "106682", "106011", "048073", "085623", 
                "046906", "106045", "047396", "047401", "106582", "047845", "047021", "048072", 
                "085953", "106604", "048086", "047151", "106056", "106111", "106694", "047397", 
                "048904", "047836", "106515", "047942", "106259", "085392", "085829", "085380", 
                "085899", "106037", "106003", "105971", "048871", "106167", "048934", "048169", 
                "048173", "085542", "048727", "048172", "048823", "106318", "047170", "106053", 
                "047835", "047167", "048229", "047893", "106295", "106516", "106171", "047166", 
                "085964", "106291", "085325", "085963", "047926", "047975", "047929", "048887", 
                "085544", "047868", "106505", "106602", "048158", "106501", "085496", "047432", 
                "047932", "085498", "085291", "048869", "048943", "047912", "106624", "047914", 
                "048386", "085532", "047645", "047631", "047911", "049553", "047384", "085802", 
                "048848", "046827", "047152", "106130", "085761", "048060", "048081", "047854", 
                "085527", "048064", "047958", "047961", "106322", "047031", "105958", "047169", 
                "046872", "048275", "085536", "085757", "085400", "085982", "106328", "085580", 
                "085548", "085541", "085565", "047618", "047656", "106523", "047450", "106094", 
                "105950", "105957", "106030", "048250", "048959", "085271", "085508", "106647", 
                "085823", "048741", "085930", "047112", "048212", "106035", "106466", "047164", 
                "048040", "085379", "085699", "047679", "049548", "049316", "106106", "047695", 
                "047826", "085981", "049765", "047725", "105976", "047674", "085525", "047891", 
                "047985", "047486", "106059", "106580", "048815", "048012", "049387", "047526", 
                "047145", "085885", "106155", "047849", "106019", "085451", "085531", "047663", 
                "085636", "085561", "049130", "085394", "047837", "047798", "085529", "047583", 
                "047739", "047899", "085956", "106008", "048935", "048960", "047990", "049268", 
                "047820", "047731", "049556", "048017", "085902", "048909", "047910", "082889", 
                "047385", "085547", "085521", "047732", "085611", "085900", "085897", "085974", 
                "102455", "048048", "106146", "046814", "085969"
            ],

            list2: (function() {
                const arr = [];
                for (let i = 543000; i <= 543635; i++) {
                    arr.push(i.toString());
                }
                return arr;
            })(),

            hGroup: [
               "106003","085823", "105972","049268","047738", "106536", "106062", "047916"
            ]
        };

        const specialGroup = [
            "085544", "048848", "048727", "046827", "047167", "106318", "047994", 
            "047509", "085389", "085409", "085977", "047163", "048046", "047032", 
            "047398", "085496", "085965", "085539", "049465", "047284", "085970", 
            "106169", "047978", "047844", "048735", "085368", "085966", "047891", 
            "047845", "105971", "047166", "106516", "106259", "106694", "543076",           
            "543567", "543025", "543261", "543428", "543183", "543351", "543049", 
            "543571", "543541", "543207", "543359", "543554", "543420", "543056", 
            "543232", "543384", "543306", "543006", "543213"
        ];

        const specialGroupForList1 = specialGroup.filter(item => data.list1.includes(item));
        const specialGroupForList2 = specialGroup.filter(item => data.list2.includes(item));

        function getTail(numStr) {
            return numStr.charAt(numStr.length - 1);
        }

        const state = {
            isRolling: false,
            list1Count: 0,
            list2Count: 0,
            selectedTailNumber: null, 
            list1Results: [],
            list2Results: [],
            rollingInterval: null,
            rollSpeed: 50,
            specialGroupEnabled: true,
            hGroupEnabled: true,
            processLog: []
        };

        function init() {
            generateCountOptions();
            generateTailNumberSelector();  
            createTechBackground();
            bindEvents();
            updateSettingsDisplay();
            console.log("抽签系统初始化完成");
            console.log("名单二数量:", data.list2.length);
            console.log("特定人员组总数:", specialGroup.length);
            console.log("特定人员组-名单一:", specialGroupForList1.length);
            console.log("特定人员组-名单二:", specialGroupForList2.length);
        }

        function generateCountOptions() {
            const sel1 = document.getElementById('list1Count');
            const sel2 = document.getElementById('list2Count');
            sel1.innerHTML = '<option value="0">请选择人数</option>';
            sel2.innerHTML = '<option value="0">请选择人数</option>';
            for (let i = 5; i <= 30; i++) {
                sel1.add(new Option(`抽取 ${i} 人`, i));
                sel2.add(new Option(`抽取 ${i} 人`, i));
            }
        }

        function generateTailNumberSelector() {
            const selector = document.getElementById('tailNumberSelector');
            selector.innerHTML = '';
            const unlimited = document.createElement('div');
            unlimited.className = 'tail-number selected';
            unlimited.textContent = '不限';
            unlimited.dataset.number = '';
            unlimited.addEventListener('click', () => selectTailNumber(''));
            selector.appendChild(unlimited);
            for (let i = 0; i <= 9; i++) {
                const el = document.createElement('div');
                el.className = 'tail-number';
                el.textContent = i;
                el.dataset.number = i;
                el.addEventListener('click', () => selectTailNumber(i));
                selector.appendChild(el);
            }
        }

        function selectTailNumber(number) {
            state.selectedTailNumber = number === '' ? null : number.toString();
            document.querySelectorAll('.tail-number').forEach(el => {
                el.classList.remove('selected');
                if ((number === '' && el.dataset.number === '') || 
                    (number !== '' && el.dataset.number === number.toString())) {
                    el.classList.add('selected');
                }
            });
            document.getElementById('tailFilterInfo').innerHTML = 
                `当前: ${state.selectedTailNumber === null ? '不限' : '尾号 ' + state.selectedTailNumber}`;
            updateSettingsDisplay();
        }

        function createTechBackground() {
            const bg = document.getElementById('techBg');
            for (let i = 0; i < 20; i++) {
                bg.appendChild(createDiv('grid-line horizontal', { top: i * 5 + '%' }));
                bg.appendChild(createDiv('grid-line vertical', { left: i * 5 + '%' }));
            }
            for (let i = 0; i < 50; i++) {
                bg.appendChild(createDiv('glowing-dots', {
                    left: Math.random() * 100 + '%',
                    top: Math.random() * 100 + '%',
                    animationDelay: Math.random() * 3 + 's',
                    animationDuration: 2 + Math.random() * 3 + 's'
                }));
            }
        }
        function createDiv(className, styles) {
            const d = document.createElement('div');
            d.className = className;
            Object.assign(d.style, styles);
            return d;
        }

        function bindEvents() {
            document.getElementById('list1Count').addEventListener('change', function(e) {
                state.list1Count = parseInt(e.target.value) || 0;
                updateSettingsDisplay();
            });
            document.getElementById('list2Count').addEventListener('change', function(e) {
                state.list2Count = parseInt(e.target.value) || 0;
                updateSettingsDisplay();
            });
            document.getElementById('startBtn').addEventListener('click', startRolling);
            document.getElementById('stopBtn').addEventListener('click', stopRolling);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('stopBtn').disabled = true;
        }

        function updateSettingsDisplay() {
            document.getElementById('list1Settings').innerHTML = 
                `抽取人数: ${state.list1Count > 0 ? state.list1Count : '未选择'}`;
            document.getElementById('list2Settings').innerHTML = 
                `抽取人数: ${state.list2Count > 0 ? state.list2Count : '未选择'}`;
        }

        function startRolling() {
            if (state.list1Count === 0 && state.list2Count === 0) {
                alert('请至少为一个名单设置抽取人数！');
                return;
            }
            if ((state.list1Count > 0 && (state.list1Count < 5 || state.list1Count > 30)) ||
                (state.list2Count > 0 && (state.list2Count < 5 || state.list2Count > 30))) {
                alert('抽取人数必须在5-30人之间！');
                return;
            }

            resetResults();
            state.isRolling = true;
            state.processLog = [];
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            const total = state.list1Count + state.list2Count;
            const specialNeed = Math.floor(total / 5);
            state.processLog.push(`总抽签人数: ${total}, 需要特定人员: ${specialNeed}`);

            const specialResults = drawSpecialGroup(specialNeed);
            state.processLog.push(`实际抽取特定人员: ${specialResults.length} 人`);

            const specialForList1 = specialResults.filter(item => data.list1.includes(item));
            const specialForList2 = specialResults.filter(item => data.list2.includes(item));
            state.processLog.push(`名单一特定: ${specialForList1.length}, 名单二特定: ${specialForList2.length}`);

            let list1Pool = data.list1.filter(item => !specialGroupForList1.includes(item));
            let list2Pool = data.list2.filter(item => !specialGroupForList2.includes(item));

            if (state.selectedTailNumber !== null) {
                list1Pool = list1Pool.filter(item => item.endsWith(state.selectedTailNumber));
                list2Pool = list2Pool.filter(item => item.endsWith(state.selectedTailNumber));
            }

            let list1Remain = state.list1Count - specialForList1.length;
            let list2Remain = state.list2Count - specialForList2.length;

            let list1Regular = list1Remain > 0 ? drawList1Regular(list1Remain, list1Pool) : [];
            let list2Regular = list2Remain > 0 ? drawList2Regular(list2Remain, list2Pool) : [];

            state.list1Results = [...specialForList1, ...list1Regular];
            state.list2Results = [...specialForList2, ...list2Regular];

            state.processLog.push(`名单一最终: ${state.list1Results.length}, 名单二最终: ${state.list2Results.length}`);
            console.log(state.processLog.join('\n'));

            prepareRollingDisplay();
            startRollingAnimation();
        }

        function drawSpecialGroup(needCount) {
            if (needCount <= 0) return [];

            let needList1 = 0, needList2 = 0;
            const both = state.list1Count > 0 && state.list2Count > 0;
            const total = state.list1Count + state.list2Count;

            if (both && total >= 10) {
                needList1 = 1;
                needList2 = 1;
                let remaining = needCount - 2;
                for (let i = 0; i < remaining; i++) {
                    if (Math.random() < 0.5) needList1++; else needList2++;
                }
            } else if (state.list1Count > 0 && state.list2Count === 0) {
                needList1 = needCount;
            } else if (state.list2Count > 0 && state.list1Count === 0) {
                needList2 = needCount;
            } else {
                const r1 = state.list1Count / total;
                needList1 = Math.round(needCount * r1);
                needList2 = needCount - needList1;
            }

            needList1 = Math.min(needList1, specialGroupForList1.length);
            needList2 = Math.min(needList2, specialGroupForList2.length);
            if (needList1 + needList2 < needCount) {
                const short = needCount - (needList1 + needList2);
                if (specialGroupForList1.length > needList1) {
                    needList1 += Math.min(short, specialGroupForList1.length - needList1);
                }
                if (needList1 + needList2 < needCount && specialGroupForList2.length > needList2) {
                    needList2 += Math.min(needCount - (needList1 + needList2), specialGroupForList2.length - needList2);
                }
            }

            const list1SpecialDrawn = drawSpecialFromPool(specialGroupForList1, needList1);
            const list2SpecialDrawn = drawSpecialFromPool(specialGroupForList2, needList2);

            return [...list1SpecialDrawn, ...list2SpecialDrawn];
        }

        function drawSpecialFromPool(pool, count) {
            if (count <= 0 || pool.length === 0) return [];
            let available = [...pool];
            const result = [];

            if (state.selectedTailNumber !== null) {
                const tailMatched = available.filter(item => item.endsWith(state.selectedTailNumber));
                const tailMatchedCount = Math.min(count, tailMatched.length);
                for (let i = 0; i < tailMatchedCount; i++) {
                    const randIdx = Math.floor(Math.random() * tailMatched.length);
                    result.push(tailMatched[randIdx]);
                    const idxInAvailable = available.indexOf(tailMatched[randIdx]);
                    if (idxInAvailable !== -1) available.splice(idxInAvailable, 1);
                    tailMatched.splice(randIdx, 1);
                }
            }

            if (result.length < count) {
                const remainNeed = count - result.length;
                const additional = drawRandomFromArray(available, remainNeed);
                result.push(...additional);
            }
            return result;
        }

        function drawRandomFromArray(arr, n) {
            if (n <= 0 || arr.length === 0) return [];
            const copy = [...arr];
            const res = [];
            const take = Math.min(n, copy.length);
            for (let i = 0; i < take; i++) {
                const idx = Math.floor(Math.random() * copy.length);
                res.push(copy[idx]);
                copy.splice(idx, 1);
            }
            return res;
        }

        function drawList1Regular(count, pool) {
            if (count <= 0 || pool.length === 0) return [];
            let weighted = [];
            if (state.hGroupEnabled) {
                const high = pool.filter(item => data.hGroup.includes(item));
                const other = pool.filter(item => !data.hGroup.includes(item));
                weighted = [...other];
                high.forEach(item => { weighted.push(item, item, item); });
            } else {
                weighted = [...pool];
            }
            return drawRandomFromArray(weighted, count);
        }

        function drawList2Regular(count, pool) {
            return drawRandomFromArray(pool, count);
        }

        function prepareRollingDisplay() {
            const area = document.getElementById('rollingArea');
            area.innerHTML = '';
            const totalSlots = state.list1Results.length + state.list2Results.length;
            if (totalSlots === 0) {
                area.innerHTML = '<div class="name-slot">无抽签结果</div>';
                return;
            }
            for (let i = 0; i < totalSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'name-slot rolling';
                slot.id = `slot-${i}`;
                if (i < state.list1Results.length) slot.classList.add('list1');
                else slot.classList.add('list2');
                const idx = i < state.list1Results.length ? i : i - state.list1Results.length;
                const list = i < state.list1Results.length ? state.list1Results : state.list2Results;
                if (specialGroup.includes(list[idx])) slot.classList.add('special');
                area.appendChild(slot);
            }
        }

        function startRollingAnimation() {
            state.rollSpeed = 50;
            clearInterval(state.rollingInterval);
            state.rollingInterval = setInterval(updateRollingDisplay, state.rollSpeed);
        }

        function updateRollingDisplay() {
            const totalSlots = state.list1Results.length + state.list2Results.length;
            for (let i = 0; i < totalSlots; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (!slot) continue;
                const isList1 = i < state.list1Results.length;
                const source = isList1 ? data.list1 : data.list2;
                let randomName;
                if (isList1 && state.selectedTailNumber !== null) {
                    const filtered = data.list1.filter(item => item.endsWith(state.selectedTailNumber));
                    if (filtered.length) randomName = filtered[Math.floor(Math.random() * filtered.length)];
                    else randomName = data.list1[Math.floor(Math.random() * data.list1.length)];
                } else {
                    randomName = source[Math.floor(Math.random() * source.length)];
                }
                slot.textContent = randomName;
            }
        }

        function stopRolling() {
            if (!state.isRolling) return;
            state.isRolling = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            const slowDown = () => {
                state.rollSpeed += 10;
                if (state.rollSpeed >= 200) {
                    clearInterval(state.rollingInterval);
                    showFinalResults();
                    return;
                }
                clearInterval(state.rollingInterval);
                state.rollingInterval = setInterval(updateRollingDisplay, state.rollSpeed);
                setTimeout(slowDown, 100);
            };
            slowDown();
        }

        function showFinalResults() {
            const totalSlots = state.list1Results.length + state.list2Results.length;
            for (let i = 0; i < totalSlots; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (!slot) continue;
                slot.classList.remove('rolling');
                const isList1 = i < state.list1Results.length;
                slot.textContent = isList1 ? state.list1Results[i] : state.list2Results[i - state.list1Results.length];
            }
            updateResultDisplay();
        }

function updateResultDisplay() {
            const r1 = document.getElementById('list1Result');
            r1.innerHTML = '';
            if (state.list1Results.length === 0) {
                r1.innerHTML = '<div class="result-item list1">未抽取名单一</div>';
            } else {
                let spCnt = 0, hpCnt = 0;
                state.list1Results.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'result-item list1';
                    if (specialGroup.includes(item)) { div.classList.add('special'); spCnt++; }
                    div.textContent = `${idx+1}. ${item}`;
                    r1.appendChild(div);
                });
         }

            const r2 = document.getElementById('list2Result');
            r2.innerHTML = '';
            if (state.list2Results.length === 0) {
                r2.innerHTML = '<div class="result-item list2">未抽取名单二</div>';
            } else {
                let spCnt = 0;
                state.list2Results.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'result-item list2';
                    if (specialGroup.includes(item)) { div.classList.add('special'); spCnt++; }
                    div.textContent = `${idx+1}. ${item}`;
                    r2.appendChild(div);
                });
            }
        }


        function resetResults() {
            state.list1Results = [];
            state.list2Results = [];
            document.getElementById('rollingArea').innerHTML = '<div class="name-slot">准备开始抽签...</div>';
            document.getElementById('list1Result').innerHTML = '<div class="result-item list1">等待抽签结果...</div>';
            document.getElementById('list2Result').innerHTML = '<div class="result-item list2">等待抽签结果...</div>';
        }

        function resetAll() {
            if (state.isRolling) {
                clearInterval(state.rollingInterval);
                state.isRolling = false;
            }
            state.list1Count = 0;
            state.list2Count = 0;
            selectTailNumber('');
            state.list1Results = [];
            state.list2Results = [];
            document.getElementById('list1Count').value = '0';
            document.getElementById('list2Count').value = '0';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            resetResults();
            updateSettingsDisplay();
            console.log("系统已重置");
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

